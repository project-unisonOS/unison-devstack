services:
  # New Intent Orchestration Services
  intent-graph:
    build:
      context: ../unison-intent-graph
    image: ghcr.io/project-unisonos/unison-intent-graph:latest
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      INTENT_GRAPH_PORT: 8080
      INTENT_GRAPH_HOST: 0.0.0.0
      CONTEXT_GRAPH_URL: http://context-graph:8081
      ORCHESTRATOR_URL: http://orchestrator:8080
      REDIS_URL: redis://redis:6379
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      inference:
        condition: service_healthy

  context-graph:
    build:
      context: ../unison-context-graph
    image: ghcr.io/project-unisonos/unison-context-graph:latest
    restart: unless-stopped
    ports:
      - "8091:8081"
    environment:
      CONTEXT_GRAPH_PORT: 8081
      CONTEXT_GRAPH_HOST: 0.0.0.0
      INTENT_GRAPH_URL: http://intent-graph:8080
      EXPERIENCE_RENDERER_URL: http://experience-renderer:8082
      REDIS_URL: redis://redis:6379
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy

  experience-renderer:
    build:
      context: ../unison-experience-renderer
    image: ghcr.io/project-unisonos/unison-experience-renderer:latest
    restart: unless-stopped
    ports:
      - "8092:8082"
    environment:
      EXPERIENCE_RENDERER_PORT: 8082
      EXPERIENCE_RENDERER_HOST: 0.0.0.0
      INTENT_GRAPH_URL: http://intent-graph:8080
      CONTEXT_GRAPH_URL: http://context-graph:8081
      ORCHESTRATOR_URL: http://orchestrator:8080
      REDIS_URL: redis://redis:6379
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      intent-graph:
        condition: service_healthy
      context-graph:
        condition: service_healthy

  agent-vdi:
    build:
      context: ../unison-agent-vdi
    image: ghcr.io/project-unisonos/unison-agent-vdi:latest
    restart: unless-stopped
    ports:
      - "8093:8083"
    environment:
      VDI_SERVICE_PORT: 8083
      VDI_SERVICE_HOST: 0.0.0.0
      INTENT_GRAPH_URL: http://intent-graph:8080
      EXPERIENCE_RENDERER_URL: http://experience-renderer:8082
      REDIS_URL: redis://redis:6379
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      intent-graph:
        condition: service_healthy
      experience-renderer:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/dri:/dev/dri

  # Enhanced Core Services
  orchestrator:
    build:
      context: ..
      dockerfile: unison-orchestrator/Dockerfile
    image: ghcr.io/project-unisonos/unison-orchestrator:latest
    restart: unless-stopped
    ports:
      - "8090:8080"
    environment:
      UNISON_CONTEXT_HOST: "context"
      UNISON_CONTEXT_PORT: "8081"
      UNISON_STORAGE_HOST: "storage"
      UNISON_STORAGE_PORT: "8082"
      UNISON_POLICY_HOST: "policy"
      UNISON_POLICY_PORT: "8083"
      UNISON_INFERENCE_HOST: "inference"
      UNISON_INFERENCE_PORT: "8087"
      # New intent orchestration endpoints
      UNISON_INTENT_GRAPH_HOST: "intent-graph"
      UNISON_INTENT_GRAPH_PORT: "8080"
      UNISON_CONTEXT_GRAPH_HOST: "context-graph"
      UNISON_CONTEXT_GRAPH_PORT: "8081"
      UNISON_EXPERIENCE_RENDERER_HOST: "experience-renderer"
      UNISON_EXPERIENCE_RENDERER_PORT: "8082"
      # M4: Auth service configuration
      UNISON_AUTH_HOST: "auth"
      UNISON_AUTH_PORT: "8088"
      UNISON_JWT_SECRET: "dev-secret-key-change-in-production-256-bits-minimum"
      # M5.1: OpenTelemetry configuration
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4318"
      OTEL_SERVICE_NAME: "unison-orchestrator"
      OTEL_SERVICE_VERSION: "1.0.0"
      OTEL_TRACES_EXPORTER: "otlp"
      OTEL_METRICS_EXPORTER: "none"
      OTEL_LOGS_EXPORTER: "none"
      # M5.2: Consent service configuration
      UNISON_CONSENT_HOST: "consent"
      UNISON_CONSENT_PORT: "7072"
      UNISON_CONSENT_SECRET: "consent-secret-key-change-in-production"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      auth:
        condition: service_healthy
      consent:
        condition: service_healthy
      storage:
        condition: service_healthy
      policy:
        condition: service_healthy
      inference:
        condition: service_healthy
      jaeger:
        condition: service_started
      context:
        condition: service_started
      intent-graph:
        condition: service_started
      context-graph:
        condition: service_started
      experience-renderer:
        condition: service_started

  # Infrastructure Services
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: unison
      POSTGRES_USER: unison
      POSTGRES_PASSWORD: unison_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U unison"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # M4: Authentication Service
  auth:
    build:
      context: ../unison-auth
    image: ghcr.io/project-unisonos/unison-auth:latest
    restart: unless-stopped
    ports:
      - "8088:8088"
    environment:
      AUTH_PORT: 8088
      AUTH_HOST: 0.0.0.0
      UNISON_JWT_SECRET: "dev-secret-key-change-in-production-256-bits-minimum"
      UNISON_ACCESS_TOKEN_EXPIRE_MINUTES: 30
      UNISON_REFRESH_TOKEN_EXPIRE_MINUTES: 1440
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      # Service authentication secrets
      UNISON_ORCHESTRATOR_SERVICE_SECRET: orchestrator-secret
      UNISON_INFERENCE_SERVICE_SECRET: inference-secret
      UNISON_POLICY_SERVICE_SECRET: policy-secret
      UNISON_CONTEXT_SERVICE_SECRET: context-secret
      UNISON_STORAGE_SERVICE_SECRET: storage-secret
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy

  # M5.2: Consent Service
  consent:
    build:
      context: ../unison-consent
    image: ghcr.io/project-unisonos/unison-consent:latest
    restart: unless-stopped
    ports:
      - "7072:7072"
    environment:
      UNISON_CONSENT_PORT: 7072
      UNISON_CONSENT_HOST: 0.0.0.0
      UNISON_CONSENT_SECRET: "consent-secret-key-change-in-production"
      UNISON_CONSENT_AUDIENCE: "orchestrator"
      UNISON_CONSENT_DEFAULT_TTL: 3600
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7072/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      redis:
        condition: service_healthy

  # M5.1: Jaeger Tracing Backend
  jaeger:
    image: jaegertracing/all-in-one:latest
    restart: unless-stopped
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC receiver
      - "4318:4318"    # OTLP HTTP receiver
      - "14250:14250"  # Jaeger gRPC
    environment:
      COLLECTOR_OTLP_ENABLED: "true"

  # Existing Services
  inference:
    build:
      context: ../unison-inference
    image: ghcr.io/project-unisonos/unison-inference:latest
    restart: unless-stopped
    ports:
      - "8087:8087"
    environment:
      UNISON_INFERENCE_PROVIDER: "ollama"
      UNISON_INFERENCE_MODEL: "llama3.2"
      OLLAMA_BASE_URL: "http://ollama:11434"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8087/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    # depends_on:
    #   - ollama  # Commented out since ollama is in tools profile

  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    pull_policy: always
    profiles:
      - tools  # optional; start with: docker compose --profile tools up ollama

  skill-register:
    build:
      context: ..
      dockerfile: unison-devstack/Dockerfile.skill-register
    image: ghcr.io/project-unisonos/unison-skill-register:latest
    depends_on:
      - orchestrator
    command: ["python", "scripts/register_skills.py"]
    environment:
      UNISON_ORCH_URL: "http://orchestrator:8080"
    profiles:
      - tools  # optional; start with: docker compose --profile tools up skill-register

  io-core:
    build:
      context: ../unison-io-core
    image: ghcr.io/project-unisonos/unison-io-core:latest
    restart: unless-stopped
    ports:
      - "8085:8085"
    environment:
      UNISON_ORCH_HOST: "orchestrator"
      UNISON_ORCH_PORT: "8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      orchestrator:
        condition: service_healthy

  io-speech:
    build:
      context: ../unison-io-speech
    image: ghcr.io/project-unisonos/unison-io-speech:latest
    restart: unless-stopped
    ports:
      - "8084:8084"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  io-vision:
    build:
      context: ../unison-io-vision
    image: ghcr.io/project-unisonos/unison-io-vision:latest
    restart: unless-stopped
    ports:
      - "8086:8086"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  context:
    build:
      context: ../unison-context
    image: ghcr.io/project-unisonos/unison-context:latest
    restart: unless-stopped
    ports:
      - "8081:8081"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      storage:
        condition: service_healthy

  storage:
    build:
      context: ../unison-storage
    image: ghcr.io/project-unisonos/unison-storage:latest
    restart: unless-stopped
    ports:
      - "8082:8082"
    volumes:
      - unison_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy

  policy:
    build:
      context: ../unison-policy
    image: ghcr.io/project-unisonos/unison-policy:latest
    restart: unless-stopped
    ports:
      - "8083:8083"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/readyz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

volumes:
  unison_data:
  ollama_data:
  redis_data:
  postgres_data:

