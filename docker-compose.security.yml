name: unison-devstack

# Security overlay for the canonical devstack compose.
# Use with:
#   docker compose -p unison-devstack -f docker-compose.yml -f docker-compose.security.yml up -d
#
# Goals:
# - Segment networks (public/internal/data/auth)
# - Keep services off the host network (do NOT include docker-compose.ports.yml)
# - Apply basic hardening knobs without breaking local dev ergonomics

services:
  # Public edge (no host ports by default in security mode).
  orchestrator:
    networks: [public, internal, auth]
    security_opt: ["no-new-privileges:true"]

  experience-renderer:
    networks: [public, internal]
    security_opt: ["no-new-privileges:true"]

  # Internal app network.
  actuation:
    networks: [internal]
    security_opt: ["no-new-privileges:true"]

  comms:
    networks: [internal]
    security_opt: ["no-new-privileges:true"]

  inference:
    networks: [internal]
    security_opt: ["no-new-privileges:true"]

  io-core:
    networks: [internal]
    security_opt: ["no-new-privileges:true"]

  io-speech:
    networks: [internal]
    security_opt: ["no-new-privileges:true"]

  io-vision:
    networks: [internal]
    security_opt: ["no-new-privileges:true"]

  io-bci:
    networks: [internal]
    security_opt: ["no-new-privileges:true"]

  intent-graph:
    networks: [internal, data]
    security_opt: ["no-new-privileges:true"]

  context-graph:
    networks: [internal, data]
    security_opt: ["no-new-privileges:true"]

  # Auth plane.
  auth:
    networks: [auth, data]
    security_opt: ["no-new-privileges:true"]

  consent:
    networks: [auth, data]
    security_opt: ["no-new-privileges:true"]

  policy:
    networks: [internal]
    security_opt: ["no-new-privileges:true"]

  # Data plane.
  context:
    networks: [internal, data]
    security_opt: ["no-new-privileges:true"]

  storage:
    networks: [internal, data]
    security_opt: ["no-new-privileges:true"]

  postgres:
    networks: [data]

  redis:
    networks: [data]

  neo4j:
    networks: [data]

  # Observability stays internal in security mode.
  jaeger:
    networks: [internal]

  # VPN/VDI: keep wiring, but don't publish to host by default in security mode.
  network-vpn:
    networks:
      internal:
        aliases:
          - agent-vdi

  # Optional tooling profiles (keep internal-only).
  ollama:
    networks: [internal]

  payments:
    networks: [internal]

networks:
  public: {}
  internal:
    internal: true
  data:
    internal: true
  auth:
    internal: true
